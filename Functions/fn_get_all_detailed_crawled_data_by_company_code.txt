-- Author: Reygie
-- Purpose: Return all data from detailed_crawled_data based of the company code given by the request
-- Modified by:
-- Modification Date:

CREATE OR REPLACE FUNCTION selenium_data.fn_get_all_detailed_crawled_data_by_company_code(
	p_companycode character varying DEFAULT NULL::character varying)
    RETURNS TABLE(id bigint, source_name text, standard_date timestamp without time zone, original_date text, date_description text, company text, country text, event_type character varying, standard_event text, original_event text, event_description text, period_end text, symbol text, isin text, url text, _time text, time_description text, time_zone text, website_region character varying, website_description text) 
    LANGUAGE 'plpgsql'

    COST 100
    VOLATILE 
    ROWS 1000
AS $BODY$
BEGIN
 RETURN QUERY
select d.id, d.source_name, d.standard_date, d.original_date, d.date_description, d.company, d.country, e.name,
d.standard_event, d.original_event, d.event_description, d.period_end, d.symbol, d.isin, d.url, d._time, d.time_description, d.time_zone,
s.website_region, s.website_description
from selenium_data.detailed_crawled_data d
LEFT JOIN selenium_data.standard_events e
ON d.standard_event = e.name
INNER JOIN selenium_data.crawl_source s
ON d.source_id = s.id
where (p_companycode IS NULL OR p_companycode = '' OR LOWER(d.company_code) ~* p_companycode) AND d.status = true
	order by d.standard_date ASC;
	
END; $BODY$;